{% extends "base.html" %}

{% block title %}Detección Facial{% endblock %}

{% block content %}
<div class="container" style="max-width: 900px; margin: 0 auto;">
    <div class="card glass-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2><i class="fas fa-expand-arrows-alt"></i> Detección Facial</h2>
            <span class="badge badge-warning" id="status-badge" style="background: var(--warning-color); color: #000; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: bold;">BUSCANDO ROSTRO</span>
        </div>

        <div class="video-container" style="position: relative; width: 100%; aspect-ratio: 4/3; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 20px;">
            <video id="video" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);"></video>
            <canvas id="canvas" style="display: none;"></canvas>
            
            <!-- Overlay UI -->
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; align-items: center; justify-content: center;">
                <div style="width: 280px; height: 350px; border: 2px dashed rgba(255,255,255,0.5); border-radius: 150px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);"></div>
            </div>
        </div>

        <div class="controls text-center">
            <p id="instruction-text" style="font-size: 1.1rem; margin-bottom: 20px;">Por favor, centra tu rostro en el óvalo</p>
            <button id="capture-btn" class="btn btn-primary" style="max-width: 200px; margin: 0 auto;" disabled>
                <i class="fas fa-check-circle"></i> Verificar Rostro
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('capture-btn');
    const statusBadge = document.getElementById('status-badge');
    const instructionText = document.getElementById('instruction-text');
    let stream = null;
    let faceCheckInterval = null;

    // Access Camera
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            startFaceDetection();
        } catch (err) {
            console.error("Error accessing camera:", err);
            instructionText.textContent = "Error: No se pudo acceder a la cámara";
            instructionText.style.color = "var(--danger-color)";
        }
    }

    // Simulate Face Detection (Client-side check before sending to server)
    function startFaceDetection() {
        faceCheckInterval = setInterval(() => {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const dataURL = canvas.toDataURL('image/jpeg');
            
            // Send frame to server for detection
            fetch('/api/process_frame', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: dataURL })
            })
            .then(res => res.json())
            .then(data => {
                if (data.face_detected) {
                    statusBadge.textContent = "ROSTRO DETECTADO";
                    statusBadge.style.background = "var(--success-color)";
                    instructionText.textContent = "Rostro verificado. Pulsa el botón para continuar.";
                    captureBtn.disabled = false;
                } else {
                    statusBadge.textContent = "BUSCANDO ROSTRO";
                    statusBadge.style.background = "var(--warning-color)";
                    instructionText.textContent = "Por favor, centra tu rostro en el óvalo";
                    captureBtn.disabled = true;
                }
            })
            .catch(err => console.error(err));
        }, 1000); // Check every second
    }

    captureBtn.addEventListener('click', () => {
        clearInterval(faceCheckInterval);
        window.location.href = "{{ url_for('formulario') }}";
    });

    // Start on load
    startCamera();

    // Cleanup
    window.addEventListener('beforeunload', () => {
        if (stream) stream.getTracks().forEach(track => track.stop());
        if (faceCheckInterval) clearInterval(faceCheckInterval);
    });
</script>
{% endblock %}
