{% extends "base.html" %}

{% block title %}Inicio - Sistema de Asistencia{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>Bienvenido, {{ current_user.first_name }}</h1>
    <p class="text-secondary">Selecciona una acci√≥n para continuar</p>
</div>

<div class="grid-menu">
    {% if show_checkout and current_attendance %}
    <div class="card glass-panel" style="border-color: var(--success-color);">
        <h2><i class="fas fa-sign-out-alt" style="color: var(--success-color);"></i> Check-out</h2>
        <p>
            Ingreso: {{ current_attendance.check_in_time.strftime('%H:%M') }}<br>
            Tiempo: <span id="worked-time" style="color: var(--text-primary); font-weight: bold;">Calculando...</span>
        </p>
        <button class="btn btn-primary" onclick="doCheckOut()" style="background: var(--success-color); color: white;">
            Finalizar Jornada
        </button>
    </div>
    {% endif %}

    <div class="card glass-panel" onclick="location.href='{{ url_for('registro') }}'" style="cursor: pointer;">
        <h2><i class="fas fa-user-clock"></i> Registrar Asistencia</h2>
        <p>Verificaci√≥n facial y comandos de voz para registrar tu entrada o salida.</p>
        <button class="btn btn-primary">Comenzar Registro</button>
    </div>

    {% if current_user.is_admin() %}
    <div class="card glass-panel" onclick="location.href='{{ url_for('admin') }}'" style="cursor: pointer;">
        <h2><i class="fas fa-cogs"></i> Administraci√≥n</h2>
        <p>Gestiona usuarios, departamentos y configuraciones del sistema.</p>
        <button class="btn btn-secondary">Ir al Panel</button>
    </div>
    {% endif %}

    <div class="card glass-panel">
        <h2><i class="fas fa-file-export"></i> Exportar Datos</h2>
        <p>Descarga los registros de asistencia en formato CSV.</p>
        <button class="btn btn-secondary" id="exportBtn" onclick="exportData()">
            {% if current_user.is_admin() %}Exportar Todo{% else %}Exportar Mis Datos{% endif %}
        </button>
    </div>

    <div class="card glass-panel">
        <h2><i class="fas fa-list-alt"></i> Ver Registros</h2>
        <p>Consulta el historial de asistencia directamente en el sistema.</p>
        <button class="btn btn-secondary" id="viewRecordsBtn" onclick="showRecords()">
            Ver Historial
        </button>
    </div>
</div>

<div class="stats-panel glass-panel card">
    <h3><i class="fas fa-chart-bar"></i> Estad√≠sticas del D√≠a</h3>
    <div class="stats-grid">
        <div class="stat-item">
            <div class="stat-value">{{ stats.total_checkins }}</div>
            <div class="stat-label">Entradas</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ stats.total_checkouts }}</div>
            <div class="stat-label">Salidas</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ stats.present_today }}</div>
            <div class="stat-label">Presentes</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ stats.late_arrivals }}</div>
            <div class="stat-label">Tardanzas</div>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="messageModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
    <div class="glass-panel" style="padding: 40px; max-width: 500px; width: 90%; text-align: center; margin: auto; position: relative; top: 50%; transform: translateY(-50%);">
        <div style="font-size: 3rem; margin-bottom: 20px;" id="modalIcon">üì≠</div>
        <h3 id="modalTitle" style="margin-bottom: 15px;">T√≠tulo</h3>
        <p id="modalMessage" style="margin-bottom: 30px; color: var(--text-secondary);">Mensaje</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-primary" onclick="closeModal()" style="width: auto;">Aceptar</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Pass data from backend to JS
    const hasRecords = {{ 'true' if has_records else 'false' }};
    const showCheckout = {{ 'true' if show_checkout else 'false' }};
    const checkInTimeStr = "{{ current_attendance.check_in_time.isoformat() if current_attendance and current_attendance.check_in_time else '' }}";

    function doCheckOut() {
        if (confirm("¬øEst√°s seguro de que quieres hacer check-out?")) {
            fetch("/api/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    window.location.reload();
                } else {
                    showModal("Error", result.error, "‚ùå");
                }
            })
            .catch(error => showModal("Error", "Error de conexi√≥n", "‚ùå"));
        }
    }

    if (showCheckout && checkInTimeStr) {
        function updateWorkedTime() {
            const checkInTime = new Date(checkInTimeStr);
            const now = new Date();
            const diff = now - checkInTime;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const timeElement = document.getElementById("worked-time");
            if (timeElement) timeElement.textContent = `${hours}h ${minutes}min`;
        }
        updateWorkedTime();
        setInterval(updateWorkedTime, 60000);
    }

    function showModal(title, message, icon = "üì≠") {
        document.getElementById("modalTitle").textContent = title;
        document.getElementById("modalMessage").textContent = message;
        document.getElementById("modalIcon").textContent = icon;
        const modal = document.getElementById("messageModal");
        modal.style.display = "block";
    }

    function closeModal() {
        document.getElementById("messageModal").style.display = "none";
    }

    function exportData() {
        if (!hasRecords) {
            showModal("Sin Registros", "No hay registros para exportar.", "üì≠");
            return;
        }
        window.location.href = "/api/export_csv";
    }

    function showRecords() {
        if (!hasRecords) {
            showModal("Sin Registros", "No hay registros para mostrar.", "üì≠");
            return;
        }
        
        fetch("/api/records")
        .then(response => response.json())
        .then(data => {
            if (data.total === 0) {
                showModal("Sin Registros", "No hay registros para mostrar.", "üì≠");
                return;
            }
            
            // Create a simple HTML table for the new window
            const recordsWindow = window.open("", "_blank");
            recordsWindow.document.write(`
                <html>
                <head>
                    <title>Registros de Asistencia</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; background: #0a0a0a; color: #fff; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #333; }
                        th { color: #a0a0a0; font-weight: 600; }
                        h1 { font-size: 1.5rem; margin-bottom: 10px; }
                    </style>
                </head>
                <body>
                    <h1>Registros de Asistencia</h1>
                    <table>
                        <thead>
                            <tr>${Object.keys(data.records[0]).map(k => `<th>${k}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${data.records.map(r => `<tr>${Object.values(r).map(v => `<td>${v}</td>`).join('')}</tr>`).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
        })
        .catch(err => showModal("Error", "No se pudieron cargar los registros", "‚ùå"));
    }

    // Close modal on outside click
    window.onclick = function(event) {
        const modal = document.getElementById("messageModal");
        if (event.target === modal) closeModal();
    };
</script>
{% endblock %}
